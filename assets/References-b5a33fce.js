import{r as n,j as e,h as fe}from"./index-b92ad479.js";import{T as ue,a as je,b as W}from"./Table-8f73397b.js";import{M as I,F as x}from"./Form-39720e29.js";import{m as M}from"./jalali-moment-abb1df22.js";import{g as N,e as K,a as V,b as ge,i as m,c as ee,u as ve,k as G,l as be,m as z,n as L,j as Ne,p as we}from"./DefaultLayout-dca0b3b8.js";import{E as Z}from"./index.es-f1a080d1.js";import{a as b}from"./axios-f13eed09.js";import{S as j}from"./sweetalert2.all-58ecf48c.js";import"./cil-user-5af1b2f2.js";function _e({referencesModalData:a,setReferencesModalData:d,showReferencesModal:P,closeReferencesModal:k,allowedPersons:C,handleRefrence:Y,tab:S,handleFinish:T,user:w,handleUploadFile:g}){var h;const[v,$]=n.useState(!1),y=C.map(s=>({value:s.id,label:`${s.first_name} ${s.last_name} - ${s.role.title}`}));y.unshift({label:"-",value:null});const F=["png","jpg","jpeg","webp"],p=s=>{const{name:t,value:_,type:c}=s.target;let E=_;if(c==="file"){const R=s.target.files[0];R&&g(R,a,d)}else t=="recive_id"&&(E=parseInt(E,10)),d(R=>({...R,[t]:E}))},f=s=>{d(t=>({...t,files:t.files.filter((_,c)=>c!==s)}))},o=s=>{const t=s.split(".");return t.length>1?t[t.length-1].toLowerCase():null};return e.jsx("div",{children:e.jsxs(I,{show:P,onHide:k,size:"xl",children:[e.jsx(I.Header,{className:"d-flex justify-content-center ",children:e.jsxs(I.Title,{className:"bold",children:["نامه شماره ",a.mail.id]})}),e.jsx(I.Body,{children:e.jsxs(x,{children:[e.jsxs(x.Group,{className:"mb-3",children:["موضوع :",e.jsx("div",{className:"p-3",children:a.mail.title})]}),e.jsx(x.Group,{className:"mb-3",children:Object.keys(a.mail.descriptions).map(s=>e.jsxs("div",{children:["صفحه ",parseInt(s,10)+1,e.jsx("br",{}),e.jsx("div",{className:"overflow-hidden border border-dark p-3",dangerouslySetInnerHTML:{__html:a.mail.descriptions[s].descriptions}}),e.jsx("br",{})]},parseInt(s,10)+1))}),a.mail.labels&&a.mail.labels.length>0&&e.jsxs(x.Group,{className:"mb-3",children:[e.jsx("div",{className:"p-4",children:"برچسب ها : "}),a.mail.labels.map((s,t)=>e.jsx(N,{className:"m-1",color:"light",size:"sm",active:!0,children:s.title},`label-${t}`))]}),a.mail.files&&a.mail.files.length>0&&e.jsxs(x.Group,{className:"mb-3",children:[e.jsx("div",{className:"p-4",children:"پیوست ها : "}),a.mail.files.map((s,t)=>e.jsx("a",{href:`http://localhost:8000/${s.file}`,target:"_blank",rel:"noopener noreferrer",children:F.includes(o(s.file))?e.jsx("img",{className:"m-3 border border-dark",src:`http://localhost:8000/${s.file}`,height:"100px",alt:"Preview"},`file-${t}`):e.jsxs(K,{className:"m-3",color:(()=>{switch(o(s.file)){case"pdf":return"danger";case"docx":return"primary";case"xlsx":return"success";case"svg":return"danger";default:return"secondary"}})(),textColor:"white",shape:"rounded",size:"xl",children:[" ",o(s.file)," "]},`file-${t}`)},`a-${t}`))]}),a.mailReference&&a.mailReference.map(s=>e.jsxs(x.Group,{className:"mb-3",children:[e.jsx("hr",{}),e.jsxs("div",{className:"row text-center",children:[e.jsx("div",{className:"col-md-4 mt-3 text-nowrap",children:s.user.first_name+" "+s.user.last_name+" - "+s.user.role.title}),e.jsxs("div",{className:"col-md-4 mt-3 text-nowrap",children:["شماره ارجاع : ",s.id]}),e.jsx("div",{className:"col-md-4 mt-3 text-nowrap",children:e.jsxs("p",{children:[M(s.created_at,"YYYY-MM-DD HH:mm:ss").locale("fa").format("jYYYY/jMM/jDD HH:mm:ss")," "]})})]}),e.jsxs(x.Group,{className:"mb-3",children:["متن ارجاع :",e.jsx("div",{className:"p-3 ",children:s.description}),s.files&&s.files.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"p-4",children:"پیوست ها : "}),s.files.map((t,_)=>e.jsx("a",{href:`http://localhost:8000/${t.file}`,target:"_blank",rel:"noopener noreferrer",children:F.includes(o(t.file))?e.jsx("img",{className:"m-3 border border-dark",src:`http://localhost:8000/${t.file}`,height:"100px",alt:"Preview"},`file-${_}`):e.jsxs(K,{className:"m-3",color:(()=>{switch(o(t.file)){case"pdf":return"danger";case"docx":return"primary";case"xlsx":return"success";case"svg":return"danger";default:return"secondary"}})(),textColor:"white",shape:"rounded",size:"xl",children:[" ",o(t.file)," "]},`file-${_}`)},`a-${_}`))]})]})]},s.id)),v?e.jsxs(e.Fragment,{children:["ارجاع به",e.jsx(V,{onChange:p,name:"recive_id",options:y,placeholder:"جستجو کنید"}),e.jsxs(x.Group,{className:" mt-2 mb-3",children:[e.jsx(x.Label,{children:" متن ارجاع"}),e.jsx(x.Control,{as:"textarea",name:"description",rows:3,onChange:p})]}),e.jsxs("div",{className:"mb-3 mt-3",children:[e.jsx(ge,{htmlFor:"file",children:"انتخاب فایل"}),e.jsx(Z,{children:e.jsx(m,{md:"9",children:e.jsx(ee,{type:"file",className:"mt-3",name:"files",onChange:p})})}),console.log(a),a.files&&((h=a.files)==null?void 0:h.map((s,t)=>e.jsxs("div",{style:{position:"relative",display:"inline-block",marginTop:"1rem"},children:[e.jsx("a",{href:`http://localhost:8000/${s}`,target:"_blank",rel:"noopener noreferrer",children:F.includes(o(s))?e.jsx("img",{className:"m-3 border border-dark",src:`http://localhost:8000/${s}`,height:"100px",alt:"Preview"},`file-${t}`):e.jsxs(K,{className:"m-3",color:(()=>{switch(o(s)){case"pdf":return"danger";case"docx":return"primary";case"xlsx":return"success";case"svg":return"danger";default:return"secondary"}})(),textColor:"white",shape:"rounded",size:"xl",style:{height:"100px",width:"100px"},children:[" ",o(s)," "]},`file-${t}`)},`a-${t}`),e.jsx(N,{style:{position:"absolute",top:"0",left:"0"},color:"danger",variant:"ghost",size:"sm",shape:"rounded-pill",onClick:()=>f(t),children:"X"},`remove-${t}`)]},`container-${t}`)))]}),e.jsx(x.Group,{className:" mt-2 mb-3",children:e.jsxs("div",{className:"row",children:[e.jsx(N,{shape:"rounded-pill",color:"danger",onClick:()=>$(!v),className:"col-md-2 mt-1 mx-auto",children:"لفو"}),e.jsx(N,{shape:"rounded-pill",color:"success",onClick:Y,className:"col-md-2 mt-1 mx-auto",children:"تایید"})]})})]}):S==="recive"&&a.mailReference[0].isFinished===0&&a.mailReference[a.mailReference.length-1].recive_id==w.id&&e.jsx(Z,{className:"align-items-center",children:e.jsx(N,{shape:"rounded-pill",color:"light",onClick:()=>$(!v),className:"col-md-1 mt-1 mx-auto",children:"ارجاع"})}),a.mailReference[0].isFinished?e.jsx("div",{className:"row text-center",children:e.jsx("h4",{className:".text-primary",children:"این ارجاع به پایان رسیده"})}):e.jsx(e.Fragment,{})]})}),e.jsxs(I.Footer,{children:[S==="recive"&&a.mailReference[0].isFinished==0&&a.mailReference[a.mailReference.length-1].recive_id==w.id&&e.jsx(N,{shape:"rounded-pill",color:"primary",onClick:()=>T(a.mail.id),className:" mt-1 d-block mx-auto",children:"اتمام ارجاع"}),e.jsx(N,{shape:"rounded-pill",color:"secondary",onClick:k,className:" mt-1 d-block mx-auto",children:"بستن"})]})]})})}function D({user:a,tab:d,data:P,page:k,setPage:C,maxPage:Y,fetchData:S,loading:T,setLoading:w,filterData:g,setFilterData:v}){var q,J,Q;const $=ve(),y=fe(l=>l.unreadRefrenceNotification),[F,p]=n.useState(!1),[f,o]=n.useState({}),[h,s]=n.useState([]),[t,_]=n.useState(!1),[c,E]=n.useState({}),[R,se]=n.useState([]),[U,le]=n.useState([]),[X,te]=n.useState([]);n.useEffect(()=>{E(g)},[]),n.useEffect(()=>{t&&(R.length==0&&ae(),U.length==0&&ie())},[t]);const re=l=>{b.post("/mail/allowedPersons/"+a.id).then(r=>{s(r.data),l(!0)}).catch(r=>{console.log(r)})},ae=()=>{b.post("/reference/senderPersons/"+a.id).then(l=>{se(l.data.map(r=>({value:r.id,text:`${r.first_name} ${r.last_name}`})))}).catch(l=>{console.log(l.response)})},ie=()=>{b.post("/reference/reciverPersons/"+a.id).then(l=>{le(l.data.map(r=>({value:r.id,text:`${r.first_name} ${r.last_name}`})))}).catch(l=>{console.log(l)})},ne=(l,r,i)=>{const u=r.files?[...r.files]:[],H=new FormData;H.append("file",l),b.post("/uploadFile",H).then(A=>{u[u.length]=A.data,i(pe=>({...pe,files:u}))}).catch(A=>{console.log(A),j.fire({icon:"error",title:"error",text:A.response.data.message})})},ce=()=>{d=="recive"?re(p):p(!0)},O=()=>{p(!1)},oe=(l,r)=>{b.post("/reference/mailReference/"+l.mail_id).then(i=>{o(i.data),ce()}).catch(i=>{console.log(i.response)}),r=="recive"&&l.status==0&&b.post("/reference/update/"+l.id).then(i=>{S(),$({type:"set",unreadRefrenceNotification:y-1})}).catch(i=>{console.log(i.response)})},de=()=>{if(console.log("referencesModalData :: ",f),f.recive_id&&f.description){const l=new FormData;Object.entries(f).forEach(([r,i])=>{r==="files"&&Array.isArray(i)?i.forEach((u,H)=>{l.append(`files[${H}]`,u)}):(r=="recive_id"||r=="mail_id"||r=="description")&&l.append(r,i)}),l.append("mail_id",f.mail.id),console.log("formData :: ",l),b.post("reference/store/"+a.id,l).then(r=>{r.data=="خطا"?j.fire({icon:"error",title:"error",text:"نامه قبلا ارجاع داده شده"}):j.fire({icon:"success",title:"success",text:r.data.msg}).then(()=>O())}).catch(r=>{console.log(r),j.fire({icon:"error",title:"Error",text:r.response.data.message})})}else j.fire({icon:"error",title:"Error",text:"فیلد های ارجاع اجباری هستند"});S()},me=(l,r)=>{let i="";return l==="send"||r==1?i="table-secondary pointer":i="pointer",i},he=l=>{const r=new FormData;r.append("mail_id",l),b.post("/reference/isFinished/"+a.id,r).then(i=>{j.fire({icon:"success",title:"success",text:i.data.msg}).then(()=>O())}).catch(i=>{j.fire({icon:"danger",title:"danger",text:res.response.data.msg})})},B=l=>{const{name:r,value:i}=l.target;E(u=>({...u,[r]:i}))},xe=()=>{w(!0);const l={};let r=[];X.length!=0&&X.forEach(i=>{r.push(i.value)}),Object.entries(c).forEach(([i,u])=>{u!==""&&(l[i]=u)}),r.length!==0&&(l.id=r),v({...l})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{"aria-label":"Toolbar with Button groups",children:[e.jsxs(G,{children:[e.jsx(m,{md:"1"}),e.jsx(m,{md:"1",className:"d-flex justify-content-center",children:e.jsx(N,{color:"warning",shape:"rounded-pill",...t?{}:{variant:"outline"},onClick:()=>_(!t),children:"فیلتر"})})]}),e.jsxs(be,{visible:t,children:[e.jsxs(G,{className:"mt-3",children:[e.jsx(m,{md:"1"}),e.jsx(m,{md:"4",children:e.jsxs(z,{className:"mb-4 flex-nowrap",children:[e.jsx(L,{id:"filter_text",children:"متن"}),e.jsx(ee,{name:"text",value:(((q=c==null?void 0:c.text)==null?void 0:q.length)??0)!==0?c.text:"",onChange:B})]})}),e.jsx(m,{md:"1"}),e.jsx(m,{md:"3",children:e.jsxs(z,{className:"mb-4 flex-nowrap",children:[e.jsx(L,{id:"filter_name",children:d=="recive"?"فرستنده":"دریافت کننده"}),e.jsx(Ne,{name:"name",options:d=="recive"?U:R,onChange:te,placeholder:"جستجو کنید",selectAllLabel:"انتخاب همه",virtualScroller:!0})]})})]}),e.jsxs(G,{className:"mt-3",children:[e.jsx(m,{md:"1"}),e.jsx(m,{md:"3",children:e.jsxs(z,{className:"mb-4 flex-nowrap",children:[e.jsx(L,{children:"وضعیت خوانده شده"}),e.jsx(V,{onChange:B,name:"status",value:(((J=c==null?void 0:c.status)==null?void 0:J.length)??0)!==0?c.status:"",options:[{label:"-",value:""},{label:"مشاهده شده ها",value:"1"},{label:"مشاهده نشده ها",value:"0"}]})]})}),e.jsx(m,{md:"1"}),e.jsx(m,{md:"2",children:e.jsxs(z,{className:"mb-4 flex-nowrap",children:[e.jsx(L,{id:"filter_files",children:"پیوست"}),e.jsx(V,{onChange:B,name:"files",value:(((Q=c==null?void 0:c.files)==null?void 0:Q.length)??0)!==0?c.files:"",options:[{label:"-",value:""},{label:"دارد",value:"1"},{label:"ندارد",value:"0"}]})]})})]}),e.jsxs(G,{className:"mt-3",children:[e.jsx(m,{md:"5"}),e.jsx(m,{md:"3",className:"d-flex justify-content-center",children:e.jsx(N,{color:"primary",shape:"rounded-pill",className:"text-nowrap",onClick:xe,size:"sm",children:"اعمال فیلتر"})}),e.jsx(m,{md:"1"})]})]})]}),e.jsx("br",{}),e.jsxs(ue,{responsive:!0,className:"text-center",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"col-1",children:[e.jsx("th",{className:"text-center col-4 font-weight-bold",children:"شماره ارجاع"}),e.jsx("th",{className:"text-center col-4 font-weight-bold",children:"تاریخ"}),d=="recive"?e.jsx("th",{className:"text-center col-4 font-weight-bold",children:"فرستنده"}):e.jsx("th",{className:"text-center col-4 font-weight-bold",children:"گیرنده"})]})}),e.jsx("tbody",{children:P&&P.map(l=>e.jsxs("tr",{onClick:()=>oe(l,d),className:me(d,l.status),children:[e.jsx("td",{children:e.jsx("p",{className:"link-dark pointer",children:l.id})}),e.jsx("td",{children:M(l.created_at,"YYYY-MM-DD HH:mm:ss").locale("fa").format("dddd D MMMM HH:mm YYYY")}),d==="recive"?e.jsx("td",{children:l.user.first_name+" "+l.user.last_name+" - "+l.user.role.title}):e.jsx("td",{children:l.recive_user.first_name+" "+l.recive_user.last_name+" - "+l.recive_user.role.title})]},l.id))})]}),e.jsx("div",{className:"col-3 d-flex justify-content-center",children:F&&e.jsx(_e,{referencesModalData:f,setReferencesModalData:o,showReferencesModal:F,closeReferencesModal:O,allowedPersons:h,handleRefrence:de,tab:d,handleFinish:he,user:a,handleUploadFile:ne})}),e.jsx(we,{align:"center",activePage:k,pages:Y,onActivePageChange:C})]})}function Ee(){const[a,d]=n.useState("recive"),[P,k]=n.useState([]),[C,Y]=n.useState(1),[S,T]=n.useState(1),[w,g]=n.useState(!0),[v,$]=n.useState({}),[y,F]=n.useState({id:localStorage.getItem("user_id"),role_id:localStorage.getItem("role_id"),first_name:localStorage.getItem("first_name"),last_name:localStorage.getItem("last_name")}),p=async()=>{let h={},s="";a=="recive"?s="/reference/referralsReceived/":s="/reference/references/",h={url:s,data:{page:C,...v}},b.post(h.url,h.data).then(t=>{k(t.data.data),T(t.data.last_page),g(!1)}).catch(t=>{console.log(t),g(!1)})};n.useEffect(()=>{g(!0),p()},[a,C,y,v]);const f=h=>{h!=a&&(g(!0),Y(1),d(h),$({}))};n.useEffect(()=>{w?j.fire({title:"درحال پردازش ... ",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{j.showLoading()}}):j.close()},[w]);const o={user:y,tab:a,data:P,page:C,setPage:Y,maxPage:S,fetchData:p,loading:w,setLoading:g,filterData:v,setFilterData:$};return e.jsx("div",{className:"row justify-content-center mt-5",children:e.jsx("div",{className:"col-md-12",children:e.jsx("div",{className:"card",children:e.jsxs(je,{defaultActiveKey:"recive",id:"fill-tab-example",className:"mb-3",fill:!0,onSelect:f,children:[e.jsx(W,{eventKey:"recive",title:"ارجاع های دریافتی",children:e.jsx(D,{...o})}),e.jsx(W,{eventKey:"send",title:"ارجاع های ارسالی",children:e.jsx(D,{...o})})]})})})})}export{Ee as default};
